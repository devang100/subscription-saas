generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  fullName      String?
  isSuperAdmin  Boolean   @default(false)
  
  refreshToken  String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  memberships   Membership[]
  auditLogs     AuditLog[]
  tasks         Task[]
  comments      Comment[]
  timeLogs      TimeLog[]
  notifications Notification[]
  uploadedFiles Attachment[]
}

// ... (Rest of User model and other models remain same, skipping to end)

model TimeLog {
  id        String   @id @default(uuid())
  taskId    String
  userId    String
  minutes   Int      // Duration in minutes
  description String?
  createdAt DateTime @default(now())
  
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String?
  type      String   // INFO, SUCCESS, WARNING, ERROR
  link      String?  
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Organization {
  id            String    @id @default(uuid())
  name          String
  slug          String    @unique
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  memberships   Membership[]
  subscription  Subscription?
  usageLogs     UsageLog[]
  auditLogs     AuditLog[]
  invitations   Invitation[]
  clients       Client[]
}

model Membership {
  id              String       @id @default(uuid())
  userId          String
  organizationId  String
  roleId          String
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role            Role         @relation(fields: [roleId], references: [id])

  @@unique([userId, organizationId])
}

model Role {
  id              String            @id @default(uuid())
  name            String            @unique
  description     String?
  isSystem        Boolean           @default(false)
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  permissions     RolePermission[]
  memberships     Membership[]
  invitations     Invitation[]
}

model Permission {
  id          String            @id @default(uuid())
  action      String
  resource    String
  description String?
  key         String            @unique
  
  roles       RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String

  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model Plan {
  id            String    @id @default(uuid())
  name          String
  stripePriceId String?
  maxUsers      Int       @default(1)
  
  usageLimits   Json?
  features      Json?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  subscriptions Subscription[]
}

model Subscription {
  id              String       @id @default(uuid())
  organizationId  String       @unique
  planId          String
  stripeSubId     String?      @unique
  status          String
  
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  plan            Plan         @relation(fields: [planId], references: [id])
}

model UsageLog {
  id             String       @id @default(uuid())
  organizationId String
  feature        String
  count          Int          @default(1)
  date           DateTime     @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id             String        @id @default(uuid())
  userId         String?
  organizationId String?
  action         String
  entity         String
  entityId       String?
  details        Json?
  ipAddress      String?
  userAgent      String?
  
  createdAt      DateTime      @default(now())

  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
}

model Invitation {
  id             String       @id @default(uuid())
  email          String
  token          String       @unique
  organizationId String
  roleId         String
  status         String       @default("pending")
  
  createdAt      DateTime     @default(now())
  expiresAt      DateTime

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           Role         @relation(fields: [roleId], references: [id])
}

// Agency OS Models

model Client {
  id             String       @id @default(uuid())
  name           String
  email          String?
  phone          String?
  status         String       @default("active")
  portalToken    String?      @unique
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  projects       Project[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  status      String   @default("active")
  
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  tasks       Task[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Task {
  id          String   @id @default(uuid())
  title       String
  description String?
  status      String   @default("TODO") // TODO, IN_PROGRESS, REVIEW, DONE
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  dueDate     DateTime?
  
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  assigneeId  String?
  assignee    User?    @relation(fields: [assigneeId], references: [id])
  
  comments    Comment[]
  timeLogs    TimeLog[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  attachments Attachment[]
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  taskId    String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  attachments Attachment[]
}

model Attachment {
  id        String   @id @default(uuid())
  fileName  String
  fileUrl   String
  fileType  String
  fileSize  Int

  taskId    String?
  task      Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)

  commentId String?
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  uploaderId String
  uploader   User   @relation(fields: [uploaderId], references: [id])

  createdAt DateTime @default(now())
}


